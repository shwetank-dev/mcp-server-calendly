name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install and build
        run: npm ci && npm run build

      - name: Prune dev dependencies
        run: npm prune --omit=dev

      - name: Install mcpb and scanner
        run: pip install mcpb mpak-scanner

      - name: Build bundle
        run: mcpb pack

      - name: Run MTF scanner
        run: |
          mpak-scanner scan *.mcpb --json > scan-results.json
          cat scan-results.json

      - name: Check for critical/high findings
        run: |
          python3 -c "
          import json, sys
          with open('scan-results.json') as f:
              results = json.load(f)
          findings = results.get('findings', [])
          critical_high = [f for f in findings if f.get('severity') in ('CRITICAL', 'HIGH')]
          if critical_high:
              print(f'FAIL: {len(critical_high)} critical/high findings')
              for f in critical_high:
                  print(f'  [{f[\"severity\"]}] {f.get(\"control\", \"\")} - {f.get(\"message\", \"\")}')
              sys.exit(1)
          print(f'PASS: No critical/high findings ({len(findings)} total findings)')
          "
